<!DOCTYPE html>
<html>
<head>
  <title>Services Monitor Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; background: #1e1e1e; color: #eee; padding: 20px; }
    .header, .header-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .tabs {
      overflow-x: auto;
      white-space: nowrap;
      background-color: #111;
      margin-bottom: 10px;
    }
    .tabs button {
      background-color: inherit;
      border: none;
      cursor: pointer;
      padding: 10px 20px;
      color: #ccc;
      font-size: 16px;
    }
    .tabs button.active { background-color: #444; color: white; }
    .tabcontent { display: none; }
    .table-wrapper { overflow-x: auto; }

    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      min-width: 700px;
    }
    th, td {
      padding: 4px 6px;
      border-bottom: 1px solid #444;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-align: left;
    }
    tr:hover { background: #2a2a2a; }
    tr.failed { background: #440000; }

    .status-active { color: #0f0; font-weight: bold; }
    .status-failed { color: #f00; font-weight: bold; }
    .status-inactive { color: #ff0; font-weight: bold; }

    input, select, button {
      background: #222;
      color: #eee;
      border: 1px solid #555;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 14px;
    }

    .button { font-size: 12px; margin-left: 2px; }

    .form-group { margin-bottom: 10px; }
    label { display: block; margin-bottom: 4px; font-size: 14px; }

    #searchInput {
      width: 100%;
      margin: 10px 0;
    }

    .summary {
      font-size: 14px;
      margin: 6px 0;
      color: #bbb;
    }

    #loadingMessage {
      text-align: center;
      padding: 20px;
      font-size: 18px;
      color: #ddd;
    }

    #toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #333;
      color: #fff;
      padding: 12px 20px;
      border-radius: 5px;
      box-shadow: 0 0 10px #000;
      z-index: 9999;
      display: none;
    }

    #spinnerOverlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      z-index: 9998;
      align-items: center;
      justify-content: center;
    }

    .spinner {
      border: 6px solid #444;
      border-top: 6px solid #0f0;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (max-width: 600px) {
      th, td { font-size: 13px; padding: 4px; }
      .button { font-size: 10px; padding: 3px 5px; }
    }
  </style>
</head>
<body>

<div class="header">
  <h1>Services Monitor Dashboard</h1>
  <div class="header-controls">
    <span id="lastUpdated">Last updated: --:--:--</span>
    <button onclick="manualRefresh()">Refresh</button>
    <select id="refreshInterval">
      <option value="60000" selected>60s</option>
      <option value="120000">120s</option>
    </select>
    <label><input type="checkbox" id="autoRefreshToggle" checked> Auto</label>
    <select id="statusFilter" onchange="applyFilters()">
      <option value="all">All</option>
      <option value="active">Active</option>
      <option value="inactive">Inactive</option>
      <option value="failed">Failed</option>
    </select>
    <button onclick="forceRefresh()">üîÅ Force Refresh Cache</button>
  </div>
</div>

<input type="text" id="searchInput" placeholder="Filter services...">
<div id="loadingMessage">‚è≥ Loading service data, please wait...</div>
<div class="tabs" id="tabButtons"></div>
<div id="tabContainer"></div>
<div id="toast">Status updated</div>
<div id="spinnerOverlay"><div class="spinner"></div></div>

<!-- + New Machine tab content -->
<div class="tabcontent" id="Nodes">
  <h2>Add Machine</h2>
  <form id="addMachineForm" onsubmit="return submitMachineForm();">
    <div class="form-group">
      <label for="name">Name:</label>
      <input required type="text" name="name" id="name">
    </div>
    <div class="form-group">
      <label for="host">IP Address:</label>
      <input required type="text" name="host" id="host">
    </div>
    <div class="form-group">
      <label for="port">Port:</label>
      <input required type="number" name="port" id="port" value="22">
    </div>
    <div class="form-group">
      <label for="user">Username:</label>
      <input required type="text" name="user" id="user" value="root">
    </div>
    <div class="form-group">
      <label for="password">Password (optional - used for key setup):</label>
      <input type="password" name="password" id="password">
    </div>
    <button type="submit">Add Machine</button>
  </form>
</div>
<script>
let lastTab = localStorage.getItem("lastTab") || "LOCAL";
let refreshTimer = null;

function fetchData() {
  showSpinner();
  fetch("/api/services")
    .then(res => res.json())
    .then(result => {
      const { data, timestamp } = result;
      document.getElementById("loadingMessage").style.display = "none";
      updateTabs(data);
      updateTimestamp(timestamp);
      hideSpinner();
      scheduleRefresh();
    })
    .catch(err => {
      document.getElementById("loadingMessage").innerText = "‚ö† Failed to load services. Please try refreshing.";
      hideSpinner();
      console.error("Fetch failed", err);
    });
}

function updateTabs(results) {
  const tabButtons = document.getElementById("tabButtons");
  const tabContainer = document.getElementById("tabContainer");
  tabButtons.innerHTML = '';
  tabContainer.innerHTML = '';

  results.forEach((node, index) => {
    const id = node.node;
    const btn = document.createElement("button");
    btn.textContent = node.node;
    btn.className = "tablinks";
    if (id === lastTab || (!lastTab && index === 0)) btn.classList.add("active");
    btn.onclick = () => switchTab(id);
    tabButtons.appendChild(btn);

    const div = document.createElement("div");
    div.id = id;
    div.className = "tabcontent";
    div.style.display = (id === lastTab) ? "block" : "none";

    const summary = document.createElement("div");
    summary.className = "summary";
    summary.id = `summary-${id}`;
    div.appendChild(summary);

    const wrapper = document.createElement("div");
    wrapper.className = "table-wrapper";

    const table = document.createElement("table");
    table.dataset.host = id;
    const thead = document.createElement("thead");
    thead.innerHTML = `
      <tr>
        <th onclick="sortTable(this)">Name</th>
        <th onclick="sortTable(this)">Load</th>
        <th onclick="sortTable(this)">Active</th>
        <th onclick="sortTable(this)">Sub</th>
        <th>Actions</th>
      </tr>`;
    table.appendChild(thead);

    const tbody = document.createElement("tbody");
    node.services.forEach(service => {
      const tr = document.createElement("tr");
      if (service.active === 'failed') tr.classList.add("failed");
		tr.innerHTML = `
		  <td>${service.name}</td>
		  <td>${service.load}</td>
		  <td class="status-${service.active}">${service.active}</td>
		  <td>${service.sub}</td>
		  <td>
			<form method="post" action="/action" style="display:inline;">
			  <input type="hidden" name="host" value="${id}">
			  <input type="hidden" name="service" value="${service.name}">
			  <button class="button" name="action" value="restart">Restart</button>
			  <button class="button" name="action" value="stop">Stop</button>
			  <button class="button" name="action" value="start">Start</button>
			</form>
			<button class="button" onclick="viewLogs('${id}', '${service.name}')">Logs</button>
		  </td>
		`;
      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    wrapper.appendChild(table);
    div.appendChild(wrapper);
    tabContainer.appendChild(div);
    updateSummary(id);
  });

  // Add the + New Machine tab manually
  const nodeBtn = document.createElement("button");
  nodeBtn.textContent = "+ New Machine";
  nodeBtn.className = "tablinks";
  nodeBtn.onclick = () => switchTab("Nodes");
  tabButtons.appendChild(nodeBtn);
  if (lastTab === "Nodes") nodeBtn.classList.add("active");
  document.getElementById("Nodes").style.display = lastTab === "Nodes" ? "block" : "none";

  applyFilters();
}

function switchTab(tabId) {
  document.querySelectorAll(".tabcontent").forEach(div => div.style.display = "none");
  document.querySelectorAll(".tablinks").forEach(btn => btn.classList.remove("active"));
  const el = document.getElementById(tabId);
  if (el) el.style.display = "block";
  const btn = Array.from(document.getElementsByClassName("tablinks")).find(b => b.textContent.trim() === tabId || b.textContent.includes(tabId));
  if (btn) btn.classList.add("active");
  lastTab = tabId;
  localStorage.setItem("lastTab", tabId);
  updateSummary(tabId);
  applyFilters();
}

function applyFilters() {
  const filter = document.getElementById("statusFilter")?.value || "all";
  const search = document.getElementById("searchInput").value.toLowerCase();
  const tab = document.getElementById(lastTab);
  if (!tab) return;
  tab.querySelectorAll("tbody tr").forEach(row => {
    const status = row.cells[2].textContent.trim().toLowerCase();
    const text = row.innerText.toLowerCase();
    row.style.display = (filter === 'all' || filter === status) && text.includes(search) ? '' : 'none';
  });
}

function sortTable(header) {
  const table = header.closest("table");
  const index = Array.from(header.parentNode.children).indexOf(header);
  const rows = Array.from(table.tBodies[0].rows);
  const asc = header.classList.toggle("asc");
  rows.sort((a, b) => a.cells[index].textContent.localeCompare(b.cells[index].textContent) * (asc ? 1 : -1));
  rows.forEach(r => table.tBodies[0].appendChild(r));
}

function updateSummary(host) {
  const tab = document.getElementById(host);
  if (!tab) return;
  let active = 0, failed = 0, inactive = 0;
  tab.querySelectorAll("tbody tr").forEach(r => {
    const s = r.cells[2].textContent.trim().toLowerCase();
    if (s === 'active') active++;
    else if (s === 'failed') failed++;
    else inactive++;
  });
  document.getElementById(`summary-${host}`).innerText =
    `‚úì Running: ${active}   ‚ö† Inactive: ${inactive}   ‚úñ Failed: ${failed}`;
}

function updateTimestamp(ts = null) {
  if (!ts) {
    document.getElementById("lastUpdated").innerText = "Last updated: --:--:--";
    return;
  }

  const date = new Date(ts * 1000); // Convert UNIX timestamp (in seconds) to milliseconds
  const formatted = date.toLocaleString(); // You can customize this if needed
  document.getElementById("lastUpdated").innerText = `Last updated: ${formatted}`;
}

function manualRefresh() {
  fetchData();
}

function forceRefresh() {
  showToast("Refreshing cache...");
  fetch("/force-refresh", { method: "POST" })
    .then(res => res.json())
    .then(json => {
      if (json.success) {
        showToast("‚úÖ Cache refreshed");
        fetchData();
      } else {
        showToast("‚ö† " + json.message);
      }
    })
    .catch(err => {
      showToast("‚ö† Refresh failed: " + err);
    });
}

function showToast(msg) {
  const toast = document.getElementById("toast");
  toast.textContent = msg;
  toast.style.display = "block";
  toast.style.opacity = 1;
  setTimeout(() => {
    toast.style.opacity = 0;
    setTimeout(() => toast.style.display = "none", 1000);
  }, 4000);
}

function showSpinner() {
  document.getElementById("spinnerOverlay").style.display = "flex";
}

function hideSpinner() {
  document.getElementById("spinnerOverlay").style.display = "none";
}

function scheduleRefresh(reset = false) {
  const auto = document.getElementById("autoRefreshToggle").checked;
  const interval = Math.max(60000, Math.min(300000, parseInt(document.getElementById("refreshInterval").value || "60000")));

  if (refreshTimer) clearTimeout(refreshTimer);

  if (auto) {
    refreshTimer = setTimeout(() => {
      fetch("/api/prefetch", { method: "POST" })
        .then(() => fetchData())  // refresh page data after cache refresh
        .catch(() => fetchData()); // fallback if prefetch fails
    }, interval);
  }

  if (reset) {
    showToast(`üîÅ Auto-refresh set to ${interval / 60000} minute(s)`);
  }
}

function waitForTab(name, retries = 10) {
  const tabExists = Array.from(document.querySelectorAll(".tablinks"))
    .some(btn => btn.textContent.trim() === name);
  if (tabExists) {
    switchTab(name);
  } else if (retries > 0) {
    setTimeout(() => waitForTab(name, retries - 1), 300);
  } else {
    showToast("‚ö† Tab '" + name + "' did not appear in time.");
  }
}

let liveLogTimer = null;
let currentLogHost = null;
let currentLogService = null;
let isLive = false;

function viewLogs(host, service) {
  currentLogHost = host;
  currentLogService = service;
  isLive = false;
  document.getElementById("liveLogBtn").textContent = "‚ñ∂ Live Logs";
  showSpinner();
  fetchLogs(false);
}

function fetchLogs(follow) {
  fetch("/logs", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ host: currentLogHost, service: currentLogService, follow })
  })
  .then(res => res.json())
  .then(result => {
    hideSpinner();
    if (result.success) {
      document.getElementById("logContent").textContent = result.logs;
      if (!isLive) {
        document.getElementById("logModal").style.display = "block";
      }
    } else {
      showToast("‚ùå Failed to fetch logs: " + result.message);
    }
  })
  .catch(err => {
    hideSpinner();
    showToast("‚ùå Error fetching logs: " + err);
  });
}


function toggleLiveLogs() {
  if (!isLive) {
    isLive = true;
    document.getElementById("liveLogBtn").textContent = "‚èπ Stop";
    liveLogTimer = setInterval(() => fetchLogs(true), 2000);
  } else {
    isLive = false;
    document.getElementById("liveLogBtn").textContent = "‚ñ∂ Live Logs";
    clearInterval(liveLogTimer);
  }
}

function closeLogModal() {
  document.getElementById("logModal").style.display = "none";
  if (liveLogTimer) clearInterval(liveLogTimer);
  isLive = false;
  document.getElementById("liveLogBtn").textContent = "‚ñ∂ Live Logs";
}

function downloadLogs() {
  const blob = new Blob([document.getElementById("logContent").textContent], { type: "text/plain" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `${currentLogService || "service"}.log`;
  a.click();
}

function submitMachineForm() {
  const form = document.getElementById("addMachineForm");
  const data = {
    name: form.name.value.trim(),
    host: form.host.value.trim(),
    port: form.port.value.trim(),
    user: form.user.value.trim(),
    password: form.password.value
  };

  const existingTabs = Array.from(document.querySelectorAll(".tablinks"))
    .map(btn => btn.textContent.trim());
  if (existingTabs.includes(data.name)) {
    showToast("‚ö† A machine named '" + data.name + "' already exists.");
    return false;
  }

  showSpinner();

  fetch("/add_node", {
    method: "POST",
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  })
  .then(res => res.json())
  .then(result => {
    hideSpinner();
    if (result.success) {
      showToast("‚úÖ Machine added!");
      form.reset();
      fetchData();
      waitForTab(data.name);
    } else {
      showToast("‚ùå Error: " + result.message);
    }
  })
  .catch(err => {
    hideSpinner();
    showToast("‚ùå Error: " + err);
  });

  return false;
}

fetchData();
</script>
<div id="logModal" style="display:none; position:fixed; top:10%; left:10%; width:80%; height:80%; background:#111; color:#eee; border:1px solid #444; padding:20px; overflow:auto; z-index:10000;">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h3 style="margin:0;">Service Logs</h3>
    <div>
      <button onclick="downloadLogs()" class="button">‚¨á Download</button>
      <button onclick="toggleLiveLogs()" class="button" id="liveLogBtn">‚ñ∂ Live Logs</button>
      <button onclick="closeLogModal()" class="button">‚úñ Close</button>
    </div>
  </div>
  <pre id="logContent" style="white-space:pre-wrap; background:#000; padding:10px; border:1px solid #333; height:90%; overflow:auto; margin-top:10px;"></pre>
</div>
</body>
</html>
